# Stepwise Claude Golden Example

This directory contains a golden run generated by the **Claude stepwise orchestrator** backend.

## Run Details

- **Backend**: `claude-step-orchestrator`
- **Flows Executed**: `signal`, `plan`
- **Initiator**: `demo-stepwise-tool`
- **Mode**: Stepwise execution (one LLM call per step)
- **Stub Mode**: Generated with `SWARM_CLAUDE_STEP_ENGINE_MODE=stub` (simulated responses)

## Directory Structure

```
stepwise-claude/
  spec.json           # Run specification (flows, backend, params)
  meta.json           # Run metadata (status, timestamps, etc.)
  events.jsonl        # Step-by-step event log
  signal/
    llm/              # LLM transcripts per step
      normalize-signal-normalizer-claude.jsonl
      frame-problem-framer-claude.jsonl
      author_reqs-requirements-author-claude.jsonl
      critique_reqs-requirements-critic-claude.jsonl
      author_bdd-bdd-author-claude.jsonl
      scope-scope-assessor-claude.jsonl
    receipts/         # Execution receipts per step
      normalize-signal-normalizer.json
      frame-problem-framer.json
      author_reqs-requirements-author.json
      critique_reqs-requirements-critic.json
      author_bdd-bdd-author.json
      scope-scope-assessor.json
  plan/
    llm/              # LLM transcripts per step
      impact-impact-analyzer-claude.jsonl
      options-design-optioneer-claude.jsonl
      adr-adr-author-claude.jsonl
      interface-interface-designer-claude.jsonl
      observability-observability-designer-claude.jsonl
      test_strategy-test-strategist-claude.jsonl
      work-work-planner-claude.jsonl
      design_critique-design-critic-claude.jsonl
    receipts/         # Execution receipts per step
      impact-impact-analyzer.json
      options-design-optioneer.json
      adr-adr-author.json
      interface-interface-designer.json
      observability-observability-designer.json
      test_strategy-test-strategist.json
      work-work-planner.json
      design_critique-design-critic.json
```

## What to Look For

### events.jsonl

The events log contains the complete execution timeline with the same structure as the Gemini backend:

- `run_created`, `run_started`, `step_start`/`step_end`, `run_completed` events
- Each event includes `engine: "claude-step"` in the payload

### llm/*.jsonl (Transcripts)

Each transcript file contains the conversation for one step:

```jsonl
{"timestamp": "...", "role": "system", "content": "Executing step X with agent Y"}
{"timestamp": "...", "role": "user", "content": "Step role: <role description>"}
{"timestamp": "...", "role": "assistant", "content": "<LLM response or stub>"}
```

In production (without stub mode), the assistant content contains:
- Actual Claude responses
- Tool calls and results
- Multi-turn reasoning chains

### receipts/*.json

Each receipt captures execution metadata:

```json
{
  "engine": "claude-step",
  "model": "claude-stub",
  "step_id": "normalize",
  "flow_key": "signal",
  "run_id": "<run-id>",
  "agent_key": "signal-normalizer",
  "started_at": "<timestamp>",
  "completed_at": "<timestamp>",
  "duration_ms": 0,
  "status": "succeeded",
  "tokens": {
    "prompt": 0,
    "completion": 0,
    "total": 0
  },
  "transcript_path": "llm/normalize-signal-normalizer-claude.jsonl"
}
```

Key fields:
- `status`: succeeded/failed/error
- `tokens`: Token usage for cost tracking
- `duration_ms`: Execution time
- `transcript_path`: Relative path to conversation log

### Claude Backend Characteristics

The Claude stepwise backend (`ClaudeStepwiseBackend`):

- Uses the Claude Agent SDK for execution
- Writes detailed transcripts to `<flow>/llm/*.jsonl`
- Writes execution receipts to `<flow>/receipts/*.json`
- Tracks token usage per step
- Enables per-step debugging and replay

### Differences from Gemini Backend

Compare this example with `stepwise-gemini/` to see:

1. **Transcript files**: Claude backend writes detailed `.jsonl` transcripts
2. **Receipt files**: Claude backend writes receipt JSON with token counts
3. **Directory structure**: Claude creates `signal/` and `plan/` subdirectories
4. **Observability**: Claude provides richer per-step debugging artifacts

## Viewing in Flow Studio

To visualize this run in Flow Studio:

```bash
make flow-studio
```

Then open: `http://localhost:5000/?run=stepwise-claude`

Flow Studio will:
- Parse `events.jsonl` for the timeline
- Load transcripts from `llm/` directories
- Display receipts with token usage
- Enable step-by-step replay

## Regenerating This Example

To regenerate this golden example:

```bash
SWARM_GEMINI_STUB=1 uv run swarm/tools/demo_stepwise_run.py \
  --backend claude-step-orchestrator \
  --flows signal,plan
```

Then copy the output from `swarm/runs/<run_id>/` to this directory.

## Related Documentation

- [Stepwise Backends](../../docs/FLOW_STUDIO.md#stepwise-backends)
- [ClaudeStepwiseBackend](../../runtime/backends/claude_stepwise.py)
- [Transcript and Receipt Schema](../../docs/transcript_receipt_schema.md)
