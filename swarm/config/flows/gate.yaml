# Flow 4 - Code → Artifact (Gate)
# Source of truth for gate flow ordering and agent roles

key: gate
title: "Flow 4 - Code → Artifact (Gate)"
description: "Pre-merge gate—audit receipts, check contracts/security/policy; recommend merge or bounce."

teaching:
  title: "Code to Artifact: The Pre-Merge Quality Gate"
  summary: "The Gate is where automated audits catch issues before merge. Critically, the Gate only applies MECHANICAL fixes (lint, format, typos). Logic/design issues bounce back to Build or Plan. This keeps the gate fast and objective."

steps:
  - id: receipt
    agents:
      - receipt-checker
    role: "Verify build_receipt.json completeness → receipt_audit.md."
    teaching_note: "Gate checkpoint: verify all build artifacts exist and receipt is well-formed."
    teaching_highlight: true
    routing:
      kind: linear
      next: contract
    teaching_notes:
      inputs:
        - "RUN_BASE/build/build_receipt.json"
        - "RUN_BASE/build/self_review.md"
      outputs:
        - "RUN_BASE/gate/receipt_audit.md"
      emphasizes:
        - "verify build receipt completeness"
        - "check all required fields present"
      constraints:
        - "set BLOCKED if receipt missing"
        - "document gaps for merge_decider"

  - id: contract
    agents:
      - contract-enforcer
    role: "Check API changes versus contracts → contract_audit.md."
    teaching_note: "Verify implementation matches api_contracts.yaml from Plan."
    teaching_highlight: true
    routing:
      kind: linear
      next: security
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/receipt_audit.md"
        - "RUN_BASE/plan/api_contracts.yaml"
        - "RUN_BASE/build/impl_changes_summary.md"
      outputs:
        - "RUN_BASE/gate/contract_audit.md"
      emphasizes:
        - "verify implementation matches contracts"
        - "detect breaking API changes"
      constraints:
        - "compare against api_contracts.yaml"
        - "flag undeclared contract changes"

  - id: security
    agents:
      - security-scanner
    role: "Run SAST and secret scans → security_audit.md."
    teaching_note: "Security checkpoint: SAST, secret detection, dependency check."
    teaching_highlight: true
    routing:
      kind: linear
      next: coverage
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/receipt_audit.md"
        - "RUN_BASE/build/impl_changes_summary.md"
        - "src/**"
      outputs:
        - "RUN_BASE/gate/security_audit.md"
      emphasizes:
        - "SAST scanning for vulnerabilities"
        - "secret detection in code"
      constraints:
        - "checkpoint, not comprehensive review"
        - "critical paths need human review"

  - id: coverage
    agents:
      - coverage-enforcer
    role: "Verify test coverage meets thresholds → coverage_audit.md."
    teaching_note: "Coverage checkpoint: verify test coverage against thresholds from test_plan.md."
    teaching_highlight: true
    routing:
      kind: linear
      next: gate_fix
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/receipt_audit.md"
        - "RUN_BASE/plan/test_plan.md"
        - "RUN_BASE/build/test_changes_summary.md"
      outputs:
        - "RUN_BASE/gate/coverage_audit.md"
      emphasizes:
        - "verify coverage meets thresholds"
        - "check BDD scenario coverage"
      constraints:
        - "compare against test_plan.md targets"
        - "flag coverage gaps"

  - id: gate_fix
    agents:
      - gate-fixer
    role: "Apply mechanical fixes only → gate_fix_summary.md."
    teaching_note: "MECHANICAL ONLY: lint, format, docstrings, typos, changelog. NO logic changes."
    teaching_highlight: true
    routing:
      kind: linear
      next: merge_decision
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/receipt_audit.md"
        - "RUN_BASE/gate/contract_audit.md"
        - "RUN_BASE/gate/security_audit.md"
        - "RUN_BASE/gate/coverage_audit.md"
      outputs:
        - "RUN_BASE/gate/gate_fix_summary.md"
      emphasizes:
        - "lint and format fixes"
        - "docstring additions"
        - "typo corrections"
      constraints:
        - "MECHANICAL ONLY"
        - "no logic changes"
        - "no API contract changes"

  - id: merge_decision
    agents:
      - merge-decider
    role: "Synthesize all checks into merge decision → merge_decision.md."
    teaching_note: "Final gate: produce MERGE/BOUNCE/ESCALATE based on all audits."
    teaching_highlight: true
    routing:
      kind: linear
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/receipt_audit.md"
        - "RUN_BASE/gate/contract_audit.md"
        - "RUN_BASE/gate/security_audit.md"
        - "RUN_BASE/gate/coverage_audit.md"
        - "RUN_BASE/gate/gate_fix_summary.md"
      outputs:
        - "RUN_BASE/gate/merge_decision.md"
      emphasizes:
        - "synthesize all audit results"
        - "produce clear MERGE/BOUNCE/ESCALATE"
      constraints:
        - "no judgment calls, just rules"
        - "document bounce reasons explicitly"

cross_cutting:
  - policy-analyst
  - risk-analyst
  - gh-reporter
